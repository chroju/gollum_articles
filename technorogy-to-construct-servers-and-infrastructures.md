サーバ/インフラを支える技術
==========

目的
----
* 低レイヤーの実践的な知識を養う。OSの挙動、チューニング、Linuxの動き方、運用としてやるべきこと。
* 古い本なのでエッセンスが抽出できれば良いかと。個別の技術に関しては適宜現代のものに置き換えたりする。

概要
----
* 1章 サーバ/インフラ構築入門　冗長化/負荷分散の基本
  * DNSラウンドロビン、ロードバランシング、keepalived、VRRPといった基本

* 2章 ワンランク上のサーバ/インフラの構築
  * リバースプロキシが実のところよくわかっていないと気付く
  * MySQLのレプリケーション（バイナリログのコピー、内部ロードバランサ）
  * ストレージサーバ（負荷を軽くする工夫、ストレージプロトコルにhttpを使用する）
  * IPVSによるLinuxのロードバランサー化

* 3章 止まらないインフラを目指すさらなる工夫
  * DNSサーバの障害は影響が大きく、万が一の場合の特定にも時間がかかるので、万全の対策（冗長化を）
  * ストレージサーバはDRBDによるミラーリング、keepalivedによるフェイルオーバー（バックアップも別で取得）

* 4章 性能向上、チューニング
  * 負荷の見極め（超重要箇所！！）
    * 推測するな、計測せよ
    * ロードアベレージが高ければ負荷はCPUかI/Oかを確認する
      * top, sar, iostat, strace, vmstat
        * sarでは%user（ユーザーモード）と%system（システムモード）のいずれで負荷が高いか見る（%iowaitも）
          * マルチコアの場合は全体を見ることを忘れずに
        * マルチプロセスよりマルチスレッドの方がメモリ空間を共有する分、使用効率が高い
        * vmstatではbi, bo（ブロックデバイス＝ディスク）との実際のやり取り数が見られる
      * I/O負荷はスワップとディスク入出力を見る、メモリ増設を検討する、CPUはアルゴリズムで対処
    * 負荷の正体を知る＝カーネルの動作を知る（プロセスの動作フローやCPU使用率、ロードアベレージの計算方法を知ろう）
    * 再起動したばかりのOSではページキャッシュがクリアされているため、ディスクI/Oがかなり大きくなる
    * OSチューニングとは負荷の原因を知り、それを取り除くこと
  * apache
    * MPMはスレッドとプロセスで2種類、それぞれの特性を知る
  * MySQL
    * サーバサイド、サーバサイド以外（テーブル設計、SQL最適化）、周辺システム（memchachedなど）
      * メモリ関連のチューニングに使えるmymemcheck
    * ボトルネックの原因を探して対処する点は変わらない

* 5章 省力運用
  * Nagios, Ganglia, Puppet, daemontools, PXE, initramfs, syslog等が並ぶ
  * Gangliaはphpベースでカスタマイズしやすい（例としてapacheプロセスの状態をグラフ化
  * daemontoolsはプロセスが落ちた場合に自動で再起動が可能、手軽にデーモンを作ることもできる
  * PXE, initramfsはネットワークブート（ブートファイルを外だしする）らしい、ディスクレス化による故障点の排除

* 6章 あのサービスの舞台裏
  * 1Aあたり、1サーバーあたりの能力、コストパフォーマンスを考える
  * システムごとにサーバーを用意するのではなく、一つのシステムで複数サイトを切り替えさせて柔軟性を保つ（KLab）
  * ロードバランサをLinuxで作り、ウェブでの出口はL2にしてしまうことで、ウェブサーバーをロードバランサ代替として起動可能としている
    * ネットワークブートを用いているので、BIOSだけ書き換えればロードバランサとして起動できる

目的に対する成果
----
* Linuxに対するチューニング技術はだいぶ体系的に学ぶことができたように思う
* 個々のコマンドに対する知識がまだ浅いので、実践機会を増やす、とにかく打って手と目になじませる
* 低レイヤーの冗長化（VRRP等）の知識を改めて総ざらいできてよかったし、もっとちゃんと押さえておきたい
* 6章でシステム構成の実例を見られてよかった。こういう機会も増やして見識を広げたい。

活用方針
----
* チューニング用コマンドの数々を実践する、高い負荷をかけたサーバーを用意したり、障害時に活用する
* 自社での冗長構成、耐障害性がどういったポリシーになっているのかを知り、改善策を探る
* IPVS、keepalived、memchachedといった基本的な知識を深める

不明点
----
* MySQLまわりの話が理解できない、しようともしていない
* 低レイヤーの冗長化の話などはすでに構築済みなのでスルーを決めているが、押さえるところは押さえる